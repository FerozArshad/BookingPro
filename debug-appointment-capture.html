<!-- 
BSP Appointment Capture Debug Test
Instructions:
1. Open this file in a browser tab with the booking form
2. Make sure you have appointments selected
3. Open Developer Console (F12)
4. Run the test functions below
-->

<script>
// Test 1: Check if appointment data is available
function testAppointmentAccess() {
    console.log('=== BSP Appointment Access Test ===');
    
    // Check various access methods
    const methods = {
        'window.getSelectedAppointments()': typeof window.getSelectedAppointments === 'function' ? window.getSelectedAppointments() : 'NOT_AVAILABLE',
        'window.selectedAppointments': window.selectedAppointments || 'NOT_AVAILABLE',
        'selectedAppointments (global)': typeof selectedAppointments !== 'undefined' ? selectedAppointments : 'NOT_AVAILABLE'
    };
    
    Object.entries(methods).forEach(([method, value]) => {
        console.log(`${method}:`, value);
    });
    
    return methods;
}

// Test 2: Test lead capture data collection
function testLeadCaptureData() {
    console.log('=== BSP Lead Capture Data Test ===');
    
    if (typeof window.bspLeadCapture === 'undefined') {
        console.error('BSP Lead Capture not loaded');
        return false;
    }
    
    if (typeof window.bspLeadCapture.collectFormData !== 'function') {
        console.error('collectFormData method not available');
        return false;
    }
    
    try {
        const formData = window.bspLeadCapture.collectFormData();
        console.log('Collected form data:', formData);
        
        // Check for appointment fields
        const appointmentFields = ['appointments', 'company', 'booking_date', 'booking_time', 'selected_date', 'selected_time'];
        const foundFields = {};
        
        appointmentFields.forEach(field => {
            if (formData.hasOwnProperty(field)) {
                foundFields[field] = formData[field];
            }
        });
        
        console.log('Appointment-related fields found:', foundFields);
        
        return {
            formData: formData,
            appointmentFields: foundFields,
            hasAppointmentData: Object.keys(foundFields).length > 0
        };
        
    } catch (e) {
        console.error('Error collecting form data:', e);
        return false;
    }
}

// Test 3: Simulate lead capture
function testLeadCapture() {
    console.log('=== BSP Lead Capture Simulation ===');
    
    if (typeof window.bspLeadCapture === 'undefined') {
        console.error('BSP Lead Capture not loaded');
        return false;
    }
    
    try {
        // Force a lead capture
        window.bspLeadCapture.captureLeadData(true);
        console.log('Lead capture initiated - check network tab for AJAX request');
        console.log('Also check the server logs for appointment data processing');
        
        return true;
        
    } catch (e) {
        console.error('Error during lead capture:', e);
        return false;
    }
}

// Test 4: Create test appointments and verify capture
function createTestAppointments() {
    console.log('=== BSP Create Test Appointments ===');
    
    // Create test appointments
    const testAppointments = [
        {
            company: 'Test Company 1',
            companyId: 'test1',
            date: '2024-01-15',
            time: '09:00 AM'
        },
        {
            company: 'Test Company 2', 
            companyId: 'test2',
            date: '2024-01-16',
            time: '10:30 AM'
        }
    ];
    
    console.log('Creating test appointments:', testAppointments);
    
    // Try to set appointments using the property descriptor
    if (typeof window.selectedAppointments !== 'undefined') {
        try {
            window.selectedAppointments = testAppointments;
            console.log('âœ“ Test appointments set successfully');
            
            // Verify they were set
            const verification = window.getSelectedAppointments ? window.getSelectedAppointments() : window.selectedAppointments;
            console.log('Verification - current appointments:', verification);
            
            // Now test data collection
            setTimeout(() => {
                const data = testLeadCaptureData();
                console.log('Data collection after setting test appointments:', data);
            }, 100);
            
            return true;
            
        } catch (e) {
            console.error('Error setting test appointments:', e);
            return false;
        }
    } else {
        console.warn('selectedAppointments not available');
        return false;
    }
}

// Run all tests
function runAllTests() {
    console.log('ðŸ” Running BSP Appointment Capture Tests...\n');
    
    console.log('ðŸ“‹ Test 1: Appointment Access');
    testAppointmentAccess();
    console.log('');
    
    console.log('ðŸ“‹ Test 2: Data Collection');
    testLeadCaptureData();
    console.log('');
    
    console.log('ðŸ“‹ Test 3: Create Test Data');
    createTestAppointments();
    console.log('');
    
    console.log('ðŸ“‹ Test 4: Capture Simulation');
    setTimeout(() => {
        testLeadCapture();
        console.log('\nâœ… All tests completed - check console output above');
        console.log('ðŸ’¡ Next: Check network tab for AJAX requests');
        console.log('ðŸ’¡ Next: Check server debug log for appointment processing');
    }, 500);
}

// Auto-run tests when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runAllTests);
} else {
    runAllTests();
}

// Make functions available globally
window.bspTestAppointmentAccess = testAppointmentAccess;
window.bspTestLeadCaptureData = testLeadCaptureData;
window.bspTestLeadCapture = testLeadCapture;
window.bspCreateTestAppointments = createTestAppointments;
window.bspRunAllTests = runAllTests;

</script>

<div style="padding: 20px; background: #f0f0f0; margin: 20px; border-radius: 5px; font-family: monospace;">
    <h3>BSP Appointment Capture Debug Test</h3>
    <p>This page will automatically run appointment capture tests when loaded.</p>
    <p>Open Developer Console (F12) to see results.</p>
    
    <h4>Manual Test Functions:</h4>
    <ul>
        <li><code>bspTestAppointmentAccess()</code> - Check appointment data access</li>
        <li><code>bspTestLeadCaptureData()</code> - Test form data collection</li>
        <li><code>bspCreateTestAppointments()</code> - Create test appointment data</li>
        <li><code>bspTestLeadCapture()</code> - Simulate lead capture</li>
        <li><code>bspRunAllTests()</code> - Run all tests</li>
    </ul>
    
    <h4>Debug Steps:</h4>
    <ol>
        <li>Load this page with booking form</li>
        <li>Select some appointments in the booking form</li>
        <li>Open Developer Console (F12)</li>
        <li>Check console output for test results</li>
        <li>Run <code>bspTestLeadCapture()</code> to test capture</li>
        <li>Check Network tab for AJAX request</li>
        <li>Check server debug log for appointment processing</li>
    </ol>
</div>